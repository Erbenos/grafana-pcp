define(["lodash","app/plugins/sdk"],function(t,e){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=127)}({0:function(e,n){e.exports=t},127:function(t,e,n){"use strict";n.r(e);var r,i=n(0),s=n.n(i),o=function(t,e,n,r){return new(n||(n=Promise))(function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,a)}u((r=r.apply(t,e||[])).next())})},a=function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},u=function(){function t(t,e){void 0===e&&(e=null),this.url=t,this.container=e,this.contextPromise=null,this.metricMetadataCache=[],this.missingMetrics=[],this.indomCache={}}return t.prototype._createContext=function(){return o(this,void 0,void 0,function(){var e,n;return a(this,function(r){switch(r.label){case 0:return console.log("** making request for context"),e=this.url+"/pmapi/context?hostspec=127.0.0.1&polltimeout=30",this.container&&(e+="&container="+this.container),[4,t.datasourceRequest({url:e})];case 1:return n=r.sent(),this.context=n.data.context,this.container?[4,t.datasourceRequest({url:this.url+"/pmapi/"+this.context+"/_store?name=pmcd.client.container&value="+this.container})]:[3,3];case 2:r.sent(),r.label=3;case 3:return s.a.isEmpty(this.metricMetadataCache)?[4,this.fetchMetricMetadata()]:[3,5];case 4:r.sent(),r.label=5;case 5:return[2]}})})},t.prototype.createContext=function(){return o(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return this.contextPromise||(this.contextPromise=this._createContext()),[4,this.contextPromise];case 1:return t.sent(),this.contextPromise=null,[2]}})})},t.prototype.ensureContext=function(t){return o(this,void 0,void 0,function(){var e;return a(this,function(n){switch(n.label){case 0:return this.context?[3,2]:[4,this.createContext()];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,4,,7]),[4,t()];case 3:return[2,n.sent()];case 4:return e=n.sent(),console.log("error",e,"creating new context..."),[4,this.createContext()];case 5:return n.sent(),[4,t()];case 6:return[2,n.sent()];case 7:return[2]}})})},t.prototype.fetchMetricMetadata=function(){return o(this,void 0,void 0,function(){var e=this;return a(this,function(n){switch(n.label){case 0:return[4,this.ensureContext(function(){return o(e,void 0,void 0,function(){var e;return a(this,function(n){switch(n.label){case 0:return[4,t.datasourceRequest({url:this.url+"/pmapi/"+this.context+"/_metric"})];case 1:return e=n.sent(),this.metricMetadataCache=e.data.metrics,[2]}})})})];case 1:return n.sent(),[2]}})})},t.prototype.findPmidForMetric=function(t){var e=this.metricMetadataCache.find(function(e){return e.name===t});return e?e.pmid:(this.missingMetrics.includes(t)||(this.missingMetrics.push(t),console.log("Cannot find pmid for "+t+". Is this PMDA enabled?")),null)},t.prototype.refreshIndoms=function(e){return o(this,void 0,void 0,function(){var n,r=this;return a(this,function(i){switch(i.label){case 0:return[4,this.ensureContext(function(){return o(r,void 0,void 0,function(){return a(this,function(n){switch(n.label){case 0:return[4,t.datasourceRequest({url:this.url+"/pmapi/"+this.context+"/_indom",params:{name:e}})];case 1:return[2,n.sent().data.instances]}})})})];case 1:return n=i.sent(),this.indomCache[e]=n.reduce(function(t,e){return t[e.instance]=e.name,t},{}),[2,this.indomCache[e]]}})})},t.prototype.fetch=function(e,n){return void 0===n&&(n=!1),o(this,void 0,void 0,function(){var r,i,s,u,c,l,h,f,p,d,v=this;return a(this,function(b){switch(b.label){case 0:return(r=e.map(function(t){return v.findPmidForMetric(t)}).filter(function(t){return t})).length?[4,this.ensureContext(function(){return o(v,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,t.datasourceRequest({url:this.url+"/pmapi/"+this.context+"/_fetch",params:{pmids:r.join(",")}})];case 1:return[2,e.sent().data]}})})})]:[2,[]];case 1:if(i=b.sent(),!n)return[3,9];s=0,u=i.values,b.label=2;case 2:return s<u.length?0==(c=u[s]).instances.length?[3,8]:-1===c.instances[0].instance?(c.instances[0].instanceName=null,[3,8]):(l=this.indomCache[c.name])?[3,4]:[4,this.refreshIndoms(c.name)]:[3,9];case 3:l=b.sent(),b.label=4;case 4:h=!1,f=0,p=c.instances,b.label=5;case 5:return f<p.length?((d=p[f]).instanceName=l[d.instance],d.instanceName||h?[3,7]:[4,this.refreshIndoms(c.name)]):[3,8];case 6:l=b.sent(),d.instanceName=l[d.instance],h=!0,b.label=7;case 7:return f++,[3,5];case 8:return s++,[3,2];case 9:return[2,i]}})})},t.prototype.store=function(e,n){return o(this,void 0,void 0,function(){var r=this;return a(this,function(i){switch(i.label){case 0:return[4,this.ensureContext(function(){return t.datasourceRequest({url:r.url+"/pmapi/"+r.context+"/_store",params:{name:e,value:n}})})];case 1:return[2,i.sent()]}})})},t}(),c=function(){function t(t,e){this.endpointRegistry=t,setInterval(this.doPollAll.bind(this),e)}return t.prototype.doPollAll=function(){for(var t=0,e=this.endpointRegistry.list();t<e.length;t++){var n=e[t];n.cleanup(),n.poll()}},t}(),l=function(){function t(){this.store={}}return t.prototype.ingest=function(t){for(var e=1e3*t.timestamp.s+t.timestamp.us/1e3,n=0,r=t.values;n<r.length;n++){var i=r[n],s=this.store[i.name];s||(s=this.store[i.name]={});for(var o=0,a=i.instances;o<a.length;o++){var u=a[o];u.instanceName in s||(s[u.instanceName]=[]),s[u.instanceName].push([u.value,e])}}},t.prototype.query=function(t){for(var e=[],n=0,r=t;n<r.length;n++){var i=r[n];if(i in this.store)for(var s in this.store[i])e.push({target:"null"===s?i:s,datapoints:this.store[i][s]})}return e},t.prototype.cleanExpiredMetrics=function(){},t}(),h=function(t,e,n,r){return new(n||(n=Promise))(function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,a)}u((r=r.apply(t,e||[])).next())})},f=function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},p=function(){function t(){this.scripts={}}return t.prototype.find=function(t){return this.scripts[t]},t.prototype.register=function(t,e){return h(this,void 0,void 0,function(){var n,r,i;return f(this,function(s){switch(s.label){case 0:return n=Math.floor(1e3*Math.random()),[4,t.store("bpftrace.control.register",n+"#"+e)];case 1:return s.sent(),[4,t.fetch(["bpftrace.control.register"])];case 2:if(r=s.sent(),i=JSON.parse(r.values[0].instances[0].value)[n],this.scripts[e]=i,console.debug("bpftrace.control.register response",i),"stopped"===i.status)throw{message:i.output};return setTimeout(this.checkScriptHealth.bind(this,t,e),1e3),[2]}})})},t.prototype.checkScriptHealth=function(t,e){return h(this,void 0,void 0,function(){var n,r,i,s,o;return f(this,function(a){switch(a.label){case 0:return n=this.scripts[e],[4,t.fetchMetricMetadata()];case 1:return a.sent(),[4,t.fetch(["bpftrace.scripts."+n.name+".status","bpftrace.scripts."+n.name+".output"])];case 2:for(r=a.sent(),i=0,s=r.values;i<s.length;i++)(o=s[i]).name==="bpftrace.scripts."+n.name+".status"?n.status=o.instances[0].value:o.name==="bpftrace.scripts."+n.name+".output"&&(n.output=o.instances[0].value);return"starting"===n.status&&(console.info("script",e,"is still starting, rescheduling health check in 1s..."),setTimeout(this.checkScriptHealth.bind(this,t,e),1e3)),[2]}})})},t}(),d=function(t,e,n,r){return new(n||(n=Promise))(function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,a)}u((r=r.apply(t,e||[])).next())})},v=function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},b=function(){function t(t,e){void 0===e&&(e=null),this.url=t,this.container=e,this.requestedMetrics={},this.context=new u(t,e),this.scriptRegistry=new p,this.datastore=new l}return t.prototype.poll=function(){return d(this,void 0,void 0,function(){var t,e;return v(this,function(n){switch(n.label){case 0:return 0==(t=Object.keys(this.requestedMetrics)).length?[2]:[4,this.context.fetch(t,!0)];case 1:return e=n.sent(),this.datastore.ingest(e),[2]}})})},t.prototype.ensurePolling=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];this.requestedMetrics[r]=(new Date).getTime()}},t.prototype.cleanup=function(){var t=(new Date).getTime()-2e4;this.requestedMetrics=s.a.pickBy(this.requestedMetrics,function(e){return e>t}),this.datastore.cleanExpiredMetrics()},t}(),y=function(){function t(){this.endpoints={}}return t.prototype.find_or_create=function(t,e){void 0===e&&(e=null);var n=t+"::"+e,r=this.endpoints[n];return r||(r=new b(t,e),this.endpoints[n]=r),r},t.prototype.list=function(){return Object.values(this.endpoints)},t}(),m=function(t,e,n,r){return new(n||(n=Promise))(function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,a)}u((r=r.apply(t,e||[])).next())})},g=function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},w=function(){function t(t,e,n,r,i){this.name=t.name,this.url=t.url,this.q=e,this.backendSrv=n,this.templateSrv=r,this.variableSrv=i,this.withCredentials=t.withCredentials,this.headers={"Content-Type":"application/json"},"string"==typeof t.basicAuth&&t.basicAuth.length>0&&(this.headers.Authorization=t.basicAuth),u.datasourceRequest=this.doRequest.bind(this),this.endpointRegistry=new y,this.poller=new c(this.endpointRegistry,1e3)}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv","variableSrv"],t.prototype.query=function(t){return m(this,void 0,void 0,function(){var e,n,r,i,s,o,a;return g(this,function(u){switch(u.label){case 0:if(0==(e=t).targets.length)return[2,{data:[]}];this.templateSrv.getAdhocFilters?e.adhocFilters=this.templateSrv.getAdhocFilters(this.name):e.adhocFilters=[],this.getVariables(),n=[],r=function(t){var e,r,s,o;return g(this,function(a){switch(a.label){case 0:return t.hide?[2,"continue"]:(e=i.endpointRegistry.find_or_create(i.url),(r=e.scriptRegistry.find(t.script))&&"started"===r.status?(s=r.vars.map(function(t){return"bpftrace.scripts."+r.name+".data."+t}),e.ensurePolling(s),n.push.apply(n,e.datastore.query(s)),[3,5]):[3,1]);case 1:return r&&"started"!==r.status?(i.handleError({message:r.output},t),[3,5]):[3,2];case 2:return a.trys.push([2,4,,5]),[4,e.scriptRegistry.register(e.context,t.script)];case 3:return a.sent(),[3,5];case 4:return o=a.sent(),i.handleError(o,t),[3,5];case 5:return[2]}})},i=this,s=0,o=e.targets,u.label=1;case 1:return s<o.length?(a=o[s],[5,r(a)]):[3,4];case 2:u.sent(),u.label=3;case 3:return s++,[3,1];case 4:return[2,{data:n}]}})})},t.prototype.handleError=function(t,e){throw t.refId=e.refId,t},t.prototype.testDatasource=function(){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:t=new u(this.url,null),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.createContext()];case 2:return e.sent(),[2,{status:"success",message:"Data source is working",title:"Success"}];case 3:return e.sent(),[2,{status:"error",message:"Cannot connect to "+t.url,title:"Error"}];case 4:return[2]}})})},t.prototype.metricFindQuery=function(t){return m(this,void 0,void 0,function(){return g(this,function(t){return[2,[]]})})},t.prototype.doRequest=function(t){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return t.withCredentials=this.withCredentials,t.headers=this.headers,[4,this.backendSrv.datasourceRequest(t)];case 1:return[2,e.sent()]}})})},t.prototype.getVariables=function(){var t={};if(!this.variableSrv.variables)return{};for(var e=0,n=this.variableSrv.variables;e<n.length;e++){var r=n[e],i=r.current.value;("$__all"===i||s.a.isEqual(i,["$__all"]))&&(i=null===r.allValue?r.options.slice(1).map(function(t){return t.value}):r.allValue),t[r.name]={text:r.current.text,value:i}}return t},t}(),x=n(3),C=(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),M=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.target.script=r.target.script||"",r}return C(e,t),e.$inject=["$scope","$injector"],e.prototype.refreshMetricData=function(){this.panelCtrl.refresh()},e.templateUrl="datasources/bpftrace/partials/query.editor.html",e}(x.QueryCtrl);n.d(e,"ConfigCtrl",function(){return S}),n.d(e,"QueryOptionsCtrl",function(){return _}),n.d(e,"AnnotationsQueryCtrl",function(){return k}),n.d(e,"Datasource",function(){return w}),n.d(e,"QueryCtrl",function(){return M});var S=function(){function t(){}return t.templateUrl="datasources/bpftrace/partials/config.html",t}(),_=function(){function t(){}return t.templateUrl="datasources/bpftrace/partials/query.options.html",t}(),k=function(){function t(){}return t.templateUrl="datasources/bpftrace/partials/annotations.editor.html",t}()},3:function(t,n){t.exports=e}})});
//# sourceMappingURL=module.js.map